events {
	worker_connections				1024;
}

http {
	include							/etc/nginx/mime.types;
	default_type					application/octet-stream;

	server {
		listen						80;
		server_name					nfordoxc.42.fr;
		return						301 https://$host$request_uri;
	}

	server {
		listen						443 ssl;
		server_name					nfordoxc.42.fr;

		ssl_certificate				/etc/nginx/ssl/nginx.crt;
		ssl_certificate_key			/etc/nginx/ssl/nginx.key;
		ssl_protocols				TLSv1.2 TLSv1.3;

		ssl_ciphers					"ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES256-GCM-SHA384";
		ssl_prefer_server_ciphers	on;
		ssl_session_timeout			5m;
		ssl_session_cache			shared:SSL:10m;
		ssl_session_tickets			off;

		add_header					Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
		add_header					X-Frame-Options SAMEORIGIN;
		add_header					X-XSS-Protection "1; mode=block";
		add_header					X-Content-Type-Options nosniff;

		root						/var/www/html;
		index						index.php index.html;

		location / {
			#try_files				$uri $uri/ =404;
			try_files				$uri $uri/ /index.php$is_args$args;
		}

		location /ping {
			return					200 "pong\n";
			add_header				Content-Type text/plain;
		}

		location ~ \.php$ {
			include					fastcgi_params;
			fastcgi_pass			wordpress:9000;
			fastcgi_index			index.php;
			fastcgi_param			SCRIPT_FILENAME $document_root$fastcgi_script_name;
			fastcgi_param			SCRIPT_NAME $fastcgi_script_name;
			access_log				/var/log/nginx/php_access.log;
			error_log				/var/log/nginx/php_error.log debug;
		}

		location = /test.php {
			include					fastcgi_params;
			fastcgi_pass			wordpress:9000;
			fastcgi_param			SCRIPT_FILENAME /var/www/html/test.php;
			fastcgi_param			SCRIPT_NAME /test.php;
		}
		
		access_log					/var/log/nginx/access.log;
		error_log					/var/log/nginx/error.log warn;
	}

	server {
		listen 443 ssl;
		server_name adminer.${DOMAIN_NAME};
		
		ssl_certificate				/etc/nginx/ssl/nginx.crt;
		ssl_certificate_key			/etc/nginx/ssl/nginx.key;
		ssl_protocols				TLSv1.2 TLSv1.3;

		ssl_ciphers					"ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES256-GCM-SHA384";
		ssl_prefer_server_ciphers	on;
		ssl_session_timeout			5m;
		ssl_session_cache			shared:SSL:10m;
		ssl_session_tickets			off;

		add_header					Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
		add_header					X-Frame-Options SAMEORIGIN;
		add_header					X-XSS-Protection "1; mode=block";
		add_header					X-Content-Type-Options nosniff;
		
		location / {
			proxy_pass				http://adminer:8080;
			proxy_set_header		Host $host;
			proxy_set_header		X-Real-IP $remote_addr;
			proxy_set_header		X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header		X-Forwarded-Proto $scheme;
		}
	}

	server {
		listen 443 ssl;
		server_name portainer.${DOMAIN_NAME};
		
		ssl_certificate				/etc/nginx/ssl/nginx.crt;
		ssl_certificate_key			/etc/nginx/ssl/nginx.key;
		ssl_protocols				TLSv1.2 TLSv1.3;

		ssl_ciphers					"ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES256-GCM-SHA384";
		ssl_prefer_server_ciphers	on;
		ssl_session_timeout			5m;
		ssl_session_cache			shared:SSL:10m;
		ssl_session_tickets			off;

		add_header					Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
		add_header					X-Frame-Options SAMEORIGIN;
		add_header					X-XSS-Protection "1; mode=block";
		add_header					X-Content-Type-Options nosniff;
		
		location / {
			proxy_pass				http://portainer:9000;
			proxy_set_header		Host $host;
			proxy_set_header		X-Real-IP $remote_addr;
			proxy_set_header		X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header		X-Forwarded-Proto $scheme;
			proxy_set_header		Connection "";
			proxy_http_version		1.1;
		}
	}
}